apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: emberlearn
data:
  kong.yml: |
    _format_version: "3.0"
    _transform: true

    services:
      # Triage Agent
      - name: triage-service
        url: http://triage-agent.emberlearn.svc.cluster.local:8001
        routes:
          - name: triage-route
            paths:
              - /api/triage
            strip_path: true
            methods:
              - GET
              - POST
        plugins:
          - name: jwt
            config:
              claims_to_verify:
                - exp
          - name: rate-limiting
            config:
              minute: 60
              policy: local

      # Concepts Agent
      - name: concepts-service
        url: http://concepts-agent.emberlearn.svc.cluster.local:8002
        routes:
          - name: concepts-route
            paths:
              - /api/concepts
            strip_path: true
            methods:
              - GET
              - POST
        plugins:
          - name: jwt
            config:
              claims_to_verify:
                - exp
          - name: rate-limiting
            config:
              minute: 60
              policy: local

      # Code Review Agent
      - name: code-review-service
        url: http://code-review-agent.emberlearn.svc.cluster.local:8003
        routes:
          - name: code-review-route
            paths:
              - /api/code-review
            strip_path: true
            methods:
              - GET
              - POST
        plugins:
          - name: jwt
            config:
              claims_to_verify:
                - exp
          - name: rate-limiting
            config:
              minute: 30
              policy: local

      # Debug Agent
      - name: debug-service
        url: http://debug-agent.emberlearn.svc.cluster.local:8004
        routes:
          - name: debug-route
            paths:
              - /api/debug
            strip_path: true
            methods:
              - GET
              - POST
        plugins:
          - name: jwt
            config:
              claims_to_verify:
                - exp
          - name: rate-limiting
            config:
              minute: 60
              policy: local

      # Exercise Agent
      - name: exercise-service
        url: http://exercise-agent.emberlearn.svc.cluster.local:8005
        routes:
          - name: exercise-route
            paths:
              - /api/exercises
            strip_path: true
            methods:
              - GET
              - POST
        plugins:
          - name: jwt
            config:
              claims_to_verify:
                - exp
          - name: rate-limiting
            config:
              minute: 30
              policy: local

      # Progress Agent
      - name: progress-service
        url: http://progress-agent.emberlearn.svc.cluster.local:8006
        routes:
          - name: progress-route
            paths:
              - /api/progress
            strip_path: true
            methods:
              - GET
              - POST
        plugins:
          - name: jwt
            config:
              claims_to_verify:
                - exp
          - name: rate-limiting
            config:
              minute: 120
              policy: local

      # Sandbox Service
      - name: sandbox-service
        url: http://sandbox.emberlearn.svc.cluster.local:8007
        routes:
          - name: sandbox-route
            paths:
              - /api/sandbox
            strip_path: true
            methods:
              - POST
        plugins:
          - name: jwt
            config:
              claims_to_verify:
                - exp
          - name: rate-limiting
            config:
              minute: 20
              policy: local
          - name: request-size-limiting
            config:
              allowed_payload_size: 1

      # Health check (no auth required)
      - name: health-service
        url: http://triage-agent.emberlearn.svc.cluster.local:8001
        routes:
          - name: health-route
            paths:
              - /health
            methods:
              - GET

    consumers:
      - username: emberlearn-frontend
        jwt_secrets:
          - key: emberlearn-jwt
            algorithm: RS256

    plugins:
      - name: cors
        config:
          origins:
            - http://localhost:3000
            - https://emberlearn.app
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
          exposed_headers:
            - X-Request-Id
          credentials: true
          max_age: 3600

      - name: request-transformer
        config:
          add:
            headers:
              - X-Request-Start:$(date +%s%3N)
